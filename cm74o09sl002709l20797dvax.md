---
title: "Dominando TransaÃ§Ãµes no CodeIgniter 3: Porque Nem Sempre Roda de Primeira"
seoTitle: "Dominando TransaÃ§Ãµes no CodeIgniter 3"
seoDescription: "Se tem uma coisa que todo dev jÃ¡ passou, Ã© aquela sensaÃ§Ã£o de fazer vÃ¡rias queries no banco e, no final, perceber que deu ruim em alguma delas. O problem..."
datePublished: Fri Feb 14 2025 11:07:54 GMT+0000 (Coordinated Universal Time)
cuid: cm74o09sl002709l20797dvax
slug: dominando-transacoes-no-codeigniter-3-porque-nem-sempre-roda-de-primeira
cover: https://cdn.hashnode.com/res/hashnode/image/upload/v1739531192581/30bf8206-2c1b-450b-9777-4962ff8cf6c2.png
ogImage: https://cdn.hashnode.com/res/hashnode/image/upload/v1739531231839/42a0f267-d42c-4f83-9834-2ac350f26ad7.png
tags: codeigniter, codeigniter-development, codeigniter3

---

Se tem uma coisa que todo dev jÃ¡ passou, Ã© aquela sensaÃ§Ã£o de fazer vÃ¡rias queries no banco e, no final, perceber que deu ruim em alguma delas. O problema? Algumas operaÃ§Ãµes foram salvas, outras nÃ£o, e agora o banco estÃ¡ mais bagunÃ§ado que um cÃ³digo sem indentaÃ§Ã£o. Mas calma! No CodeIgniter 3, temos as transaÃ§Ãµes para salvar o dia (e o banco de dados)!

## ObservaÃ§Ã£o

VocÃª verÃ¡ a seguir utilizaÃ§Ã£o do `$thisâ†’dbâ†’query(â€˜SQLâ€¦â€˜)` eu nÃ£o recomendo, conforme o artigo que falo sobre [Boas PrÃ¡ticas de Models](https://blog.mariolucas.me/escrevendo-bons-models-com-codeigniter-3), se nÃ£o leu dÃª uma conferida. O intuito desse pequeno artigo Ã© sobre transactions especificamente, entÃ£o, solte as pedras, obrigado!

## O Que SÃ£o TransaÃ§Ãµes?

Basicamente, uma transaÃ§Ã£o permite agrupar vÃ¡rias operaÃ§Ãµes do banco de dados em um sÃ³ pacote. Se tudo correr bem, a gente confirma (commit). Se algo der errado, desfazemos tudo (rollback). Assim, evitamos dados inconsistentes e garantimos que o sistema nÃ£o vire um pandemÃ´nio.

Mas atenÃ§Ã£o: para usar transaÃ§Ãµes no MySQL, o tipo de tabela precisa ser **InnoDB**. Se estiver usando **MyISAM**, esquece transaÃ§Ãµes e bora converter esse banco!

## Como o CodeIgniter 3 Lida com TransaÃ§Ãµes?

A galera do CodeIgniter 3 implementou um sistema de transaÃ§Ãµes bem tranquilo, inspirado na popular biblioteca ADODB. O objetivo? Facilitar a vida e reduzir a quantidade de cÃ³digo repetitivo.

Agora, bora ver como rodar transaÃ§Ãµes na prÃ¡tica!

### O BÃ¡sico das TransaÃ§Ãµes no CodeIgniter 3

Tudo comeÃ§a com `$this->db->trans_start();` e termina com `$this->db->trans_complete();`. Exemplo:

```php
$this->db->trans_start();
$this->db->query("INSERT INTO usuarios (nome) VALUES ('JoÃ£o')");
$this->db->query("UPDATE contas SET saldo = saldo - 100 WHERE usuario_id = 1");
$this->db->trans_complete();
```

Se uma dessas queries falhar, **nada serÃ¡ salvo**. Se tudo correr bem, o commit acontece automaticamente. FÃ¡cil, nÃ©?

### E Se Algo Der Errado? Tratando Erros

Se quiser um controle mais fino, dÃ¡ para verificar se a transaÃ§Ã£o deu certo:

```php
$this->db->trans_start();
$this->db->query("INSERT INTO usuarios (nome) VALUES ('Maria')");
$this->db->query("UPDATE contas SET saldo = saldo - 50 WHERE usuario_id = 2");
$this->db->trans_complete();

if ($this->db->trans_status() === FALSE) {
    // Algo deu errado, faz rollback e registra o erro
    log_message('error', 'Erro na transaÃ§Ã£o do banco!');
}
```

Se o commit falhar, dÃ¡ para logar o erro e tomar uma aÃ§Ã£o. Nada de deixar o banco ao Deus-darÃ¡!

### Modo Estrito: Quando o CI3 Fica Exigente

Por padrÃ£o, o CodeIgniter 3 usa **Modo Estrito**. Isso significa que se uma transaÃ§Ã£o dentro de um grupo falhar, ele reverte tudo. Mas se quiser desativar esse comportamento e tratar cada grupo separadamente, basta fazer:

```php
$this->db->trans_strict(FALSE);
```

### Desativando TransaÃ§Ãµes: Deixa Rolar (NÃ£o Recomendo, Mas Ok)

Se, por algum motivo, quiser desativar transaÃ§Ãµes e deixar que cada query seja salva automaticamente, use:

```php
$this->db->trans_off();
```

Assim, mesmo dentro de um bloco de transaÃ§Ãµes, cada operaÃ§Ã£o serÃ¡ confirmada no banco. Mas, sÃ©rio, pensa bem antes de fazer isso! ğŸ«£

### Testando Sem Medo: Modo de Teste

Quer testar suas queries sem medo de bagunÃ§ar o banco? Use o **modo de teste**, que faz rollback automÃ¡tico:

```php
$this->db->trans_start(true); // TRUE ativa o modo de teste
$this->db->query("DELETE FROM usuarios");
$this->db->trans_complete();
```

Assim, mesmo se a query for bem-sucedida, **nada serÃ¡ salvo**. Ãštil para testar sem comprometer os dados reais!

### Controle Total: Gerenciando TransaÃ§Ãµes Manualmente

Se preferir um controle manual, pode usar `trans_begin()`, `trans_commit()` e `trans_rollback()`, como neste exemplo:

```php
$this->db->trans_begin();

$this->db->query("INSERT INTO pedidos (usuario_id, valor) VALUES (3, 150.00)");
$this->db->query("UPDATE contas SET saldo = saldo - 150 WHERE usuario_id = 3");

if ($this->db->trans_status() === FALSE) {
    $this->db->trans_rollback(); // Deu ruim? Cancela tudo!
} else {
    $this->db->trans_commit(); // Tudo certo? Confirma!
}
```

Dessa forma, sÃ³ fazemos o commit se todas as queries rodarem com sucesso. Caso contrÃ¡rio, jogamos tudo fora e evitamos inconsistÃªncias!

---

## ConclusÃ£o

Usar transaÃ§Ãµes no CodeIgniter 3 nÃ£o sÃ³ evita problemas no banco de dados, como tambÃ©m deixa o cÃ³digo mais seguro e confiÃ¡vel. Com apenas algumas linhas, conseguimos garantir que todas as operaÃ§Ãµes sejam executadas juntas ou nenhuma seja salva.

EntÃ£o, bora evitar aquele pesadelo de dados inconsistentes e comeÃ§ar a usar transaÃ§Ãµes do jeito certo! ğŸ˜‰